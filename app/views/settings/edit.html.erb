<%= render 'settings/layout', active: 'edit' do %>
  <div class="settings-form-section">
    <h3 class="settings-section-title">Profile Details</h3>
    <p class="settings-section-desc">You have full control to manage your own account setting.</p>
    <%= form_with model: @user, url: settings_path, local: true, html: { multipart: true, class: 'settings-form' } do |f| %>
      <input type="hidden" id="remove-avatar-field" name="remove_avatar" value="false" />
      <input type="hidden" id="remove-background-field" name="remove_background_image" value="false" />
      <input type="file" id="avatar-upload-input" name="user[avatar]" accept="image/png,image/jpg,image/jpeg" style="display:none;" />
      <input type="file" id="background-upload-input" name="user[background_image]" accept="image/png,image/jpg,image/jpeg" style="display:none;" />
      <div class="settings-form-group">
        <%= f.label :full_name, 'Your Name' %>
        <%= f.text_field :full_name, class: 'settings-input', required: true %>
      </div>
      <div class="settings-form-row">
        <div class="settings-form-group">
          <%= f.label :phone, 'Phone' %>
          <%= f.text_field :phone, class: 'settings-input' %>
        </div>
        <div class="settings-form-group">
          <%= f.label :email, 'Email' %>
          <%= f.email_field :email, class: 'settings-input', required: true, disabled: true %>
        </div>
      </div>
      <div class="settings-form-group">
        <%= f.label :about, 'About' %>
        <%= f.text_area :about, class: 'settings-textarea', rows: 3 %>
      </div>
      
      <div class="settings-form-group">
        <%= f.label :naming_preference, 'Naming Preference' %>
        <div class="settings-preference-options">
          <% @naming_preferences.each do |preference| %>
            <div class="settings-preference-option">
              <%= f.radio_button :naming_preference, preference[:id], id: "settings_#{preference[:id]}" %>
              <%= f.label "naming_preference_#{preference[:id]}", preference[:name], for: "settings_#{preference[:id]}" %>
              <span class="settings-preference-desc"><%= preference[:description] %></span>
            </div>
          <% end %>
        </div>
      </div>
      
      <%= f.submit 'Update Profile', class: 'settings-update-btn' %>
    <% end %>
  </div>
  <div id="avatar-loader" class="processing-overlay" style="display:none;z-index:10000;">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="loader-text">Processing your avatar...</p>
    </div>
  </div>
  <div id="background-loader" class="processing-overlay" style="display:none;z-index:10000;">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="loader-text">Processing your background image...</p>
    </div>
  </div>

  <!-- Avatar Options Modal -->
  <div id="avatar-options-modal" class="avatar-options-modal">
    <div class="avatar-options-overlay" onclick="closeAvatarOptionsModal()"></div>
    <div class="avatar-options-dialog">
      <div class="avatar-options-header">
        <h3 class="avatar-options-title">Update Profile Picture</h3>
        <button class="avatar-options-close" onclick="closeAvatarOptionsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="avatar-options-body">
        <button type="button" class="avatar-options-btn avatar-options-upload-btn" onclick="uploadAvatarFromModal();">
          <i class="fas fa-upload"></i>
          <span>Upload Photo</span>
        </button>
        <% if @user.avatar.attached? %>
          <button type="button" class="avatar-options-btn avatar-options-delete-btn" onclick="deleteAvatarFromModal();">
            <i class="fas fa-trash"></i>
            <span>Remove Photo</span>
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Image Cropping Modal -->
  <div id="image-crop-modal" class="image-crop-modal">
    <div class="image-crop-overlay" onclick="closeImageCropModal()"></div>
    <div class="image-crop-dialog">
      <div class="image-crop-header">
        <h3 class="image-crop-title">Crop Your Image</h3>
        <button class="image-crop-close" onclick="closeImageCropModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="image-crop-body">
        <div class="image-crop-main">
          <div class="image-crop-container-wrapper">
            <div class="image-crop-container">
              <img id="image-crop-preview" src="" alt="Crop preview" style="max-width: 100%; display: block;">
            </div>
            <div class="image-crop-drag-hint">
              <i class="fas fa-arrows-alt"></i>
              <span>Drag to reposition</span>
            </div>
          </div>
        </div>
        <div class="image-crop-controls">
          <div class="image-crop-control-group">
            <div class="image-crop-rotation-controls">
              <button type="button" class="image-crop-rotate-btn" onclick="rotateImage(-90)" title="Rotate counter-clockwise">
                <i class="fas fa-undo"></i>
              </button>
              <button type="button" class="image-crop-rotate-btn" onclick="rotateImage(90)" title="Rotate clockwise">
                <i class="fas fa-redo"></i>
              </button>
            </div>
            <div class="image-crop-zoom-controls">
              <button type="button" id="image-crop-zoom-minus-btn" class="image-crop-zoom-btn" onclick="zoomImage(-0.1)">
                <i class="fas fa-minus"></i>
              </button>
              <div class="image-crop-zoom-slider-wrapper">
                <input type="range" id="image-crop-zoom-slider" class="image-crop-zoom-slider" min="0" max="2" step="0.1" value="1" oninput="updateZoom(this.value)">
                <label for="image-crop-zoom-slider" class="image-crop-zoom-label">Zoom</label>
              </div>
              <button type="button" id="image-crop-zoom-plus-btn" class="image-crop-zoom-btn" onclick="zoomImage(0.1)">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="image-crop-footer">
        <button type="button" class="image-crop-btn image-crop-cancel-btn" onclick="closeImageCropModal()">
          Cancel
        </button>
        <button type="button" class="image-crop-btn image-crop-save-btn" onclick="saveCroppedImage()">
          <i class="fas fa-check"></i>
          Save & Upload
        </button>
      </div>
    </div>
  </div>

  <!-- Background Image Cropping Modal -->
  <div id="background-crop-modal" class="background-crop-modal">
    <div class="background-crop-overlay" onclick="closeBackgroundCropModal()"></div>
    <div class="background-crop-dialog">
      <div class="background-crop-header">
        <h3 class="background-crop-title">Crop Your Background Image</h3>
        <button class="background-crop-close" onclick="closeBackgroundCropModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="background-crop-body">
        <div class="background-crop-main">
          <div class="background-crop-container-wrapper">
            <div class="background-crop-container">
              <img id="background-crop-preview" src="" alt="Background crop preview" style="max-width: 100%; display: block;">
            </div>
            <div class="background-crop-drag-hint">
              <i class="fas fa-arrows-alt"></i>
              <span>Drag to reposition</span>
            </div>
          </div>
        </div>
        <div class="background-crop-controls">
          <div class="background-crop-control-group">
            <div class="background-crop-rotation-controls">
              <button type="button" class="background-crop-rotate-btn" onclick="rotateBackgroundImage(-90)" title="Rotate counter-clockwise">
                <i class="fas fa-undo"></i>
              </button>
              <button type="button" class="background-crop-rotate-btn" onclick="rotateBackgroundImage(90)" title="Rotate clockwise">
                <i class="fas fa-redo"></i>
              </button>
            </div>
            <div class="background-crop-zoom-controls">
              <button type="button" id="background-crop-zoom-minus-btn" class="background-crop-zoom-btn" onclick="zoomBackgroundImage(-0.1)">
                <i class="fas fa-minus"></i>
              </button>
              <div class="background-crop-zoom-slider-wrapper">
                <input type="range" id="background-crop-zoom-slider" class="background-crop-zoom-slider" min="0" max="2" step="0.1" value="1" oninput="updateBackgroundZoom(this.value)">
                <label for="background-crop-zoom-slider" class="background-crop-zoom-label">Zoom</label>
              </div>
              <button type="button" id="background-crop-zoom-plus-btn" class="background-crop-zoom-btn" onclick="zoomBackgroundImage(0.1)">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="background-crop-footer">
        <button type="button" class="background-crop-btn background-crop-cancel-btn" onclick="closeBackgroundCropModal()">
          Cancel
        </button>
        <button type="button" class="background-crop-btn background-crop-save-btn" onclick="saveCroppedBackgroundImage()">
          <i class="fas fa-check"></i>
          Save & Upload
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirmation-modal" class="confirmation-modal">
    <div class="confirmation-overlay"></div>
    <div class="confirmation-dialog">
      <div class="confirmation-header">
        <h3 class="confirmation-title">Confirm Action</h3>
        <button class="confirmation-close" onclick="closeConfirmationModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="confirmation-body">
        <div class="confirmation-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <p class="confirmation-message" id="confirmation-message">Are you sure you want to delete this item?</p>
        <p class="confirmation-warning">This action cannot be undone.</p>
      </div>
      <div class="confirmation-footer">
        <button class="confirmation-btn confirmation-btn-cancel" onclick="closeConfirmationModal()">Cancel</button>
        <button class="confirmation-btn confirmation-btn-confirm" id="confirmation-confirm-btn">Confirm</button>
      </div>
    </div>
  </div>

  <%= render 'shared/settings_js' %>
<% end %> 