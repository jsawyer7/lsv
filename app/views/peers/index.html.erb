<div class="feed-main peers-page-main">
  <div class="peers-page-content">
    <header class="peers-page-header">
      <h1 class="peers-page-title">Peers</h1>
      <nav class="peers-page-filters">
        <%= link_to 'Suggestions', peers_path(tab: 'suggestions'), class: "peers-filter-pill #{'active' if @tab == 'suggestions'}" %>
        <%= link_to 'Following', peers_path(tab: 'following'), class: "peers-filter-pill #{'active' if @tab == 'following'}" %>
        <%= link_to 'Requests', peers_path(tab: 'requests'), class: "peers-filter-pill #{'active' if @tab == 'requests'}" %>
      </nav>
    </header>
    <div class="peers-main">
    <% if @tab == 'requests' %>
      <div class="peers-know-block">
        <div class="peers-know-header">
          <h3 class="peers-know-title">Top Requests</h3>
        </div>
        <div class="peers-know-divider"></div>
        <div class="peers-suggestions-list peers-know-list <%= 'peers-know-empty' unless @requests.any? %>">
          <% if @requests.any? %>
            <% @requests.each do |peer_request| %>
              <% user = peer_request.user %>
              <div class="peer-row">
                <%= link_to user_profile_path(user), class: 'peer-row-link' do %>
                  <%= image_tag user.avatar_url.presence || 'default-avatar.png', class: 'peer-row-avatar' %>
                  <div class="peer-row-info">
                    <div class="peer-row-name-row">
                      <span class="peer-row-name"><%= user.full_name.presence || user.email %></span>
                      <span class="peer-row-verified"><%= image_tag 'blue-tick.svg', alt: 'Verified', class: 'peer-row-verified-icon' %></span>
                    </div>
                    <div class="peer-row-meta">
                      <% religion_label = if user.religious_tradition.present? && user.religious_tradition != 'not_specified'
                        case user.religious_tradition
                        when 'muslim' then 'Islamic Student'
                        when 'jewish' then 'Jewish Student'
                        when 'christian' then 'Christian Student'
                        when 'other' then 'Other Student'
                        else "#{user.religious_tradition.humanize} Student"
                        end
                      else
                        'Religion Student'
                      end %>
                      <span class="peer-row-subtitle"><%= religion_label %></span>
                      <span class="peer-row-rating">★ 4.7</span>
                    </div>
                  </div>
                <% end %>
                <div class="peer-row-actions">
                  <a href="#" class="peer-row-ignore">Ignore</a>
                  <%= button_to 'Accept', accept_peers_path(user_id: user.id), method: :post, class: 'add-peer-btn peers-add-btn' %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="no-requests-message">No requests available.</div>
          <% end %>
        </div>
      </div>
    <% elsif @tab == 'following' %>
      <div class="peers-know-block">
        <div class="peers-know-header">
          <h3 class="peers-know-title">Following</h3>
        </div>
        <div class="peers-know-divider"></div>
        <div class="peers-suggestions-list peers-know-list">
          <% if @following.any? %>
            <% @following.each do |user| %>
              <div class="peer-row">
                <%= link_to user_profile_path(user), class: 'peer-row-link' do %>
                  <%= image_tag user.avatar_url.presence || 'default-avatar.png', class: 'peer-row-avatar' %>
                  <div class="peer-row-info">
                    <div class="peer-row-name-row">
                      <span class="peer-row-name"><%= user.full_name.presence || user.email %></span>
                      <span class="peer-row-verified"><%= image_tag 'blue-tick.svg', alt: 'Verified', class: 'peer-row-verified-icon' %></span>
                    </div>
                    <div class="peer-row-meta">
                      <% religion_label = if user.religious_tradition.present? && user.religious_tradition != 'not_specified'
                        case user.religious_tradition
                        when 'muslim' then 'Islamic Student'
                        when 'jewish' then 'Jewish Student'
                        when 'christian' then 'Christian Student'
                        when 'other' then 'Other Student'
                        else "#{user.religious_tradition.humanize} Student"
                        end
                      else
                        'Religion Student'
                      end %>
                      <span class="peer-row-subtitle"><%= religion_label %></span>
                      <span class="peer-row-rating">★ 4.7</span>
                    </div>
                  </div>
                <% end %>
                <div class="peer-row-actions">
                  <%= form_with url: follow_path(user.id), method: :delete, class: 'peer-unfollow-btn' do %>
                    <%= button_tag type: 'submit', class: 'peer-unfollow-btn-submit', data: { confirm: 'Are you sure you want to unfollow?' } do %>
                      <span class="peer-followed-text">Followed</span>
                      <span class="peer-unfollow-text">Unfollow</span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="no-requests-message">You have not followed anyone yet.</div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="peers-know-block">
        <div class="peers-know-header">
          <h3 class="peers-know-title">Peoples you may know</h3>
          <%= link_to 'Show all', peers_path(tab: 'suggestions'), class: 'peers-know-show-all' %>
        </div>
        <div class="peers-know-divider"></div>
        <div class="peers-suggestions-list peers-know-list">
          <% if @suggested_users.any? %>
            <% @suggested_users.each do |user| %>
              <div class="peer-row">
                <%= link_to user_profile_path(user), class: 'peer-row-link' do %>
                  <%= image_tag user.avatar_url.presence || 'default-avatar.png', class: 'peer-row-avatar' %>
                  <div class="peer-row-info">
                    <div class="peer-row-name-row">
                      <span class="peer-row-name"><%= user.full_name.presence || user.email %></span>
                      <span class="peer-row-verified"><%= image_tag 'blue-tick.svg', alt: 'Verified', class: 'peer-row-verified-icon' %></span>
                    </div>
                    <div class="peer-row-meta">
                      <% religion_label = if user.religious_tradition.present? && user.religious_tradition != 'not_specified'
                        case user.religious_tradition
                        when 'muslim' then 'Islamic Student'
                        when 'jewish' then 'Jewish Student'
                        when 'christian' then 'Christian Student'
                        when 'other' then 'Other Student'
                        else "#{user.religious_tradition.humanize} Student"
                        end
                      else
                        'Religion Student'
                      end %>
                      <span class="peer-row-subtitle"><%= religion_label %></span>
                      <span class="peer-row-rating">★ 4.7</span>
                    </div>
                  </div>
                <% end %>
                <div class="peer-row-actions">
                  <a href="#" class="peer-row-ignore">Ignore</a>
                  <% if Peer.exists?(user_id: current_user.id, peer_id: user.id, status: 'pending') %>
                    <span class="add-peer-btn request-sent-text">Request Sent</span>
                  <% elsif Peer.exists?(user_id: user.id, peer_id: current_user.id, status: 'pending') %>
                    <%= button_to 'Accept Request', accept_peers_path(user_id: user.id), method: :post, class: 'add-peer-btn peers-add-btn' %>
                  <% else %>
                    <%= form_with url: add_peers_path(peer_id: user.id), method: :post, class: 'add-peer-btn peers-add-btn' do %>
                      <%= button_tag type: 'submit', class: 'peers-add-btn-submit' do %>+ Add Peer<% end %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="no-requests-message">No suggestions available at this time.</div>
          <% end %>
        </div>
      </div>
    <% end %>
    </div>
  </div>
  <aside class="feed-rightbar peers-page-rightbar">
    <div class="peers-rightbar-inner">
      <div class="my-peers-section">
        <h4>My Peers</h4>
        <% if @my_peers_display.present? %>
          <% @my_peers_display.each do |peer| %>
            <% is_static = peer.respond_to?(:static?) && peer.static? %>
            <div class="my-peer-row">
              <% if is_static %>
                <span class="my-peer-avatar-wrap">
                  <%= image_tag peer.avatar_url.presence || 'default-avatar.png', class: 'my-peer-avatar' %>
                </span>
                <div class="my-peer-right-col">
                  <span class="my-peer-row-link my-peer-row-link-static my-peer-details-inner">
                    <div class="my-peer-name-row">
                      <span class="my-peer-name"><%= peer.full_name %></span>
                      <%= image_tag 'blue-tick.svg', alt: 'Verified', class: 'my-peer-verified-icon' %>
                    </div>
                    <div class="my-peer-meta">
                      <div class="my-peer-followers-avatars">
                        <% peer.followers.to_a.first(3).each do |follower| %>
                          <%= image_tag follower.avatar_url.presence || 'default-avatar.png', class: 'my-peer-follower-avatar' %>
                        <% end %>
                      </div>
                      <span class="my-peer-followers-count"><%= peer.followers.count %> followers</span>
                      <span class="my-peer-rating">★ 4.7</span>
                    </div>
                  </span>
                  <span class="my-peer-followed-static">Followed</span>
                </div>
              <% else %>
                <div class="my-peer-avatar-wrap">
                  <%= link_to user_profile_path(peer), class: 'my-peer-avatar-link' do %>
                    <%= image_tag peer.avatar_url.presence || 'default-avatar.png', class: 'my-peer-avatar' %>
                  <% end %>
                </div>
                <div class="my-peer-right-col">
                  <%= link_to user_profile_path(peer), class: 'my-peer-details-link' do %>
                    <div class="my-peer-name-row">
                      <span class="my-peer-name"><%= peer.full_name.presence || peer.email %></span>
                      <%= image_tag 'blue-tick.svg', alt: 'Verified', class: 'my-peer-verified-icon' %>
                    </div>
                    <div class="my-peer-meta">
                      <div class="my-peer-followers-avatars">
                        <% peer.followers.to_a.first(3).each do |follower| %>
                          <%= image_tag follower.avatar_url.presence || 'default-avatar.png', class: 'my-peer-follower-avatar' %>
                        <% end %>
                      </div>
                      <span class="my-peer-followers-count"><%= peer.followers.count %> followers</span>
                      <span class="my-peer-rating">★ 4.7</span>
                    </div>
                  <% end %>
                  <% if current_user.following.include?(peer) %>
                    <%= form_with url: follow_path(peer.id), method: :delete, class: 'peer-unfollow-btn my-peer-follow-btn' do %>
                      <%= button_tag type: 'submit', class: 'peer-unfollow-btn-submit', data: { confirm: 'Are you sure you want to unfollow?' } do %>
                        <span class="peer-followed-text">Followed</span>
                        <span class="peer-unfollow-text">Unfollow</span>
                      <% end %>
                    <% end %>
                  <% else %>
                    <%= button_to 'Follow', follows_path(followed_user_id: peer.id), method: :post, class: 'my-peer-follow-btn' %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
          <% if @my_peers_count > 5 %>
            <div class="my-peer-show-more">Show more</div>
          <% end %>
        <% else %>
          <div class="no-peers-message">No Peers added.</div>
        <% end %>
      </div>
      <%= render 'facts/top_facts', top_facts: @top_facts || [] %>
    </div>
  </aside>
</div>
