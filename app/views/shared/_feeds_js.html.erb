<script>

document.body.style.overflow = 'hidden';
document.documentElement.style.overflow = 'hidden';
window.addEventListener('beforeunload', function() {
  document.body.style.overflow = '';
  document.documentElement.style.overflow = '';
});

document.addEventListener('DOMContentLoaded', function() {
  const feedList = document.getElementById('feed-list');
  const feedLoader = document.getElementById('feed-loader');
  let page = 1;
  let loading = false;
  let hasMore = true;
  
  if (feedList) {
    feedList.style.pointerEvents = 'auto';
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'less than a minute';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''}`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''}`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} day${days > 1 ? 's' : ''}`;
    const weeks = Math.floor(days / 7);
    if (weeks < 4) return `${weeks} week${weeks > 1 ? 's' : ''}`;
    const months = Math.floor(days / 30);
    if (months < 12) return `${months} month${months > 12 ? 's' : ''}`;
    const years = Math.floor(days / 365);
    return `${years} year${years > 1 ? 's' : ''}`;
  }

  function renderClaim(claim) {
    if (claim.html) {
      return claim.html;
    }
    return '';
  }

  async function fetchClaims() {
    if (loading || !hasMore) return;
    loading = true;
    if (page === 1) {
      feedLoader.style.display = 'block';
    }
    try {
      const res = await fetch(`/feeds/infinite?page=${page}`);
      const data = await res.json();
      if (data.claims && data.claims.length > 0) {
        feedLoader.style.display = 'none';
        data.claims.forEach(claim => {
          feedList.insertAdjacentHTML('beforeend', renderClaim(claim));
        });
      }
      hasMore = data.has_more;
      loading = false;
      feedLoader.style.display = hasMore ? 'block' : 'none';
      page++;
    } catch (error) {
      console.error('Error fetching feeds:', error);
      loading = false;
      feedLoader.style.display = 'none';
    }
  }

  function onFeedScroll() {
    if (feedList.scrollTop + feedList.clientHeight >= feedList.scrollHeight - 200) {
      fetchClaims();
    }
  }

  feedList.addEventListener('scroll', onFeedScroll);
  
  const feedArea = document.querySelector('.feed-center') || feedList.parentElement;
  if (feedArea) {
    feedArea.addEventListener('wheel', function(e) {
      const rect = feedList.getBoundingClientRect();
      const x = e.clientX;
      const y = e.clientY;
      
      if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
        e.preventDefault();
        
        const deltaY = e.deltaY;
        feedList.scrollTop += deltaY;
        
        onFeedScroll();
      }
    }, { passive: false });
  }
  
  feedList.addEventListener('click', function(e) {
    const likeButton = e.target.closest('.feed-like');
    if (!likeButton || likeButton.tagName !== 'A') return;
    
    e.preventDefault();
    const claimId = likeButton.getAttribute('data-claim-id');
    const isLiked = likeButton.classList.contains('liked');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    let url, method;
    if (isLiked) {
      url = likeButton.href;
      method = 'DELETE';
    } else {
      url = `/claims/${claimId}/likes`;
      method = 'POST';
    }
    
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
        'Accept': 'application/json'
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        const likeCountSpan = likeButton.querySelector('.like-count');
        if (likeCountSpan) {
          likeCountSpan.textContent = data.likes_count;
        }
        
        if (isLiked) {
          likeButton.classList.remove('liked');
          likeButton.href = `/claims/${claimId}/likes`;
          likeButton.setAttribute('data-method', 'post');
          likeButton.setAttribute('data-remote', 'true');
        } else {
          likeButton.classList.add('liked');
          if (data.like_id) {
            likeButton.href = `/claims/${claimId}/likes/${data.like_id}`;
            likeButton.setAttribute('data-method', 'delete');
            likeButton.setAttribute('data-remote', 'true');
          }
        }
      }
    })
    .catch(error => {
      console.error('Error liking/unliking:', error);
    });
  });
  
  feedList.addEventListener('click', function(e) {
    const commentButton = e.target.closest('.feed-action-comment');
    if (!commentButton) return;
    
    e.preventDefault();
    const claimId = commentButton.getAttribute('data-claim-id');
    if (!claimId) return;
    
    const feedCard = commentButton.closest('.feed-card-block');
    if (!feedCard) return;
    
    const commentsSection = feedCard.querySelector(`.feed-card-comments-section[data-claim-id="${claimId}"]`);
    if (!commentsSection) return;
    
    const isVisible = commentsSection.classList.contains('visible');
    if (isVisible) {
      commentsSection.classList.remove('visible');
      commentsSection.style.display = 'none';
    } else {
      commentsSection.style.display = 'block';
      commentsSection.offsetHeight;
      commentsSection.classList.add('visible');
    }
  });
  
  feedList.addEventListener('keypress', function(e) {
    if (e.target.classList.contains('feed-card-comment-input') && e.key === 'Enter') {
      e.preventDefault();
      const input = e.target;
      const commentText = input.value.trim();
      const claimId = input.getAttribute('data-claim-id');
      
      if (!commentText || !claimId) return;
      
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      
      fetch(`/claims/${claimId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          comment: {
            content: commentText
          }
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.message || 'Failed to post comment');
          }).catch(() => {
            throw new Error('Network response was not ok');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success' && data.comment) {
          input.value = '';
          
          const commentsSection = input.closest('.feed-card-comments-section');
          const commentsList = commentsSection?.querySelector('.feed-card-comments-list');
          
          if (commentsList && data.comment) {
            const temp = document.createElement('div');
            temp.innerHTML = data.comment;
            const commentElement = temp.firstElementChild;
            
            if (commentElement) {
              commentsList.insertBefore(commentElement, commentsList.firstChild);
            }
          }
          
          const feedCard = input.closest('.feed-card-block');
          if (feedCard) {
            const actualCommentCount = commentsList ? commentsList.querySelectorAll('.comment-item').length : 0;
            const commentCountSpan = feedCard.querySelector('.comment-count');
            let newCount = actualCommentCount;
            
            if (commentCountSpan) {
              commentCountSpan.textContent = newCount;
            } else {
              const commentAction = feedCard.querySelector('.feed-action-comment');
              if (commentAction && newCount > 0) {
                const countSpan = document.createElement('span');
                countSpan.className = 'comment-count';
                countSpan.textContent = newCount;
                const commentIcon = commentAction.querySelector('.comment-icon');
                if (commentIcon && commentIcon.nextSibling) {
                  commentAction.insertBefore(countSpan, commentIcon.nextSibling);
                } else {
                  commentAction.appendChild(countSpan);
                }
              }
            }
            
            const commentTextSpan = feedCard.querySelector('.comment-text');
            if (commentTextSpan) {
              commentTextSpan.textContent = `${newCount} Comment${newCount !== 1 ? 's' : ''}`;
            }
            
            if (commentsSection) {
              let mostRelevantDiv = commentsSection.querySelector('.feed-card-most-relevant');
              if (newCount >= 1) {
                if (!mostRelevantDiv) {
                  mostRelevantDiv = document.createElement('div');
                  mostRelevantDiv.className = 'feed-card-most-relevant';
                  const span = document.createElement('span');
                  span.className = 'most-relevant-text';
                  span.textContent = 'Most Relevant';
                  const img = document.createElement('img');
                  img.src = '<%= asset_path("mearrow.svg") %>';
                  img.alt = 'Arrow';
                  img.className = 'most-relevant-arrow';
                  mostRelevantDiv.appendChild(span);
                  mostRelevantDiv.appendChild(img);
                  
                  const commentForm = commentsSection.querySelector('.feed-card-comment-form');
                  const commentsListForInsert = commentsSection.querySelector('.feed-card-comments-list');
                  
                  if (commentForm && commentsListForInsert) {
                    commentsSection.insertBefore(mostRelevantDiv, commentsListForInsert);
                  } else if (commentForm) {
                    commentsSection.appendChild(mostRelevantDiv);
                  } else if (commentsListForInsert) {
                    commentsSection.insertBefore(mostRelevantDiv, commentsListForInsert);
                  } else {
                    commentsSection.appendChild(mostRelevantDiv);
                  }
                }
                mostRelevantDiv.style.display = 'block';
              } else {
                if (mostRelevantDiv) {
                  mostRelevantDiv.style.display = 'none';
                }
              }
            }
          }
        } else if (data.status === 'error') {
          alert(data.message || 'Failed to post comment');
        } else {
          console.warn('Unexpected response format:', data);
        }
      })
      .catch(error => {
        console.error('Error posting comment:', error);
        if (input.value.trim() === commentText) {
          alert('Failed to post comment. Please try again.');
        }
      });
    }
  });
  
  fetchClaims();
});
</script> 