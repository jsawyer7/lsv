<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchForm = document.querySelector('form[data-controller="search"]');
    const searchInput = searchForm?.querySelector('input[data-search-target="input"]');
    
    if (searchForm && searchInput) {
      // Prevent default form submission
      searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
      });

      // Handle Enter key press
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const query = this.value;
          const url = new URL(window.location);
          
          if (query) {
            url.searchParams.set('search', query);
          } else {
            url.searchParams.delete('search');
          }
          
          window.history.pushState({}, '', url);
          searchForm.submit();
        }
      });
    }

    // Mobile menu toggle
    const menuToggle = document.querySelector('.menu-toggle');
    const navItems = document.querySelector('.nav-items');
    
    if (menuToggle && navItems) {
      menuToggle.addEventListener('click', function() {
        const expanded = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', !expanded);
        navItems.classList.toggle('show');
      });
    }

    // Facebook-style dropdown system with smooth animations
    class DropdownManager {
      constructor() {
        this.userProfile = document.querySelector('.user-profile');
        this.userInfo = document.querySelector('.user-info');
        this.dropdownMenu = document.querySelector('.dropdown-menu');
        
        this.isDropdownOpen = false;
        this.isSubmenuOpen = false;
        this.animationTimeout = null;
        
        this.init();
      }
      
      init() {
        this.bindEvents();
      }
      
      bindEvents() {
        // Main dropdown toggle
        if (this.userInfo && this.dropdownMenu) {
          this.userInfo.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleDropdown();
          });
        }
        
        // Settings submenu click functionality (Facebook-style)
        const settingsParent = document.querySelector('.dropdown-parent');
        if (settingsParent) {
          settingsParent.addEventListener('click', (e) => {
            console.log('Settings clicked');
            e.stopPropagation();
            this.showSubmenu();
            
            // Visual test - change background color temporarily
            settingsParent.style.backgroundColor = '#e3f0ff';
            setTimeout(() => {
              settingsParent.style.backgroundColor = '';
            }, 1000);
          });
        } else {
          console.log('Settings parent not found');
        }
        
        // Back button functionality
        const backBtn = document.querySelector('.settings-back-btn');
        if (backBtn) {
          backBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.closeSubmenu();
          });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.userProfile?.contains(e.target)) {
            this.closeAllDropdowns();
          }
        });
        
        // Close on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.closeAllDropdowns();
          }
        });
        
        // Prevent submenu from closing when clicking inside it
        const submenuContent = document.querySelector('.submenu-content');
        if (submenuContent) {
          submenuContent.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        }
      }
      
      toggleDropdown() {
        if (this.isDropdownOpen) {
          this.closeAllDropdowns();
        } else {
          this.showDropdown();
        }
      }
      
      showDropdown() {
        this.clearAnimationTimeout();
        this.dropdownMenu?.classList.add('show');
        this.userInfo?.classList.add('active');
        this.isDropdownOpen = true;
      }
      
      hideDropdown() {
        this.dropdownMenu?.classList.remove('show');
        this.dropdownMenu?.classList.remove('submenu-active');
        this.dropdownMenu?.classList.remove('submenu-open');
        this.userInfo?.classList.remove('active');
        this.isDropdownOpen = false;
        this.closeSubmenu();
      }
      
      showSubmenu() {
        this.clearAnimationTimeout();
        console.log('showSubmenu called');
        
        // Simple approach - add class immediately
        this.dropdownMenu?.classList.add('submenu-active');
        console.log('Added submenu-active class');
        console.log('Dropdown classes:', this.dropdownMenu?.classList.toString());
        
        this.isSubmenuOpen = true;
      }
      
      hideSubmenu() {
        this.clearAnimationTimeout();
        
        // Remove morphing class immediately for smooth transition back
        this.dropdownMenu?.classList.remove('submenu-active');
        this.dropdownMenu?.classList.remove('submenu-open');
        this.isSubmenuOpen = false;
      }
      
      closeSubmenu() {
        this.hideSubmenu();
      }
      
      closeAllDropdowns() {
        this.hideDropdown();
        this.closeSubmenu();
      }
      
      clearAnimationTimeout() {
        if (this.animationTimeout) {
          clearTimeout(this.animationTimeout);
          this.animationTimeout = null;
        }
      }
    }
    
    // Initialize the dropdown manager
    new DropdownManager();
  });
</script> 