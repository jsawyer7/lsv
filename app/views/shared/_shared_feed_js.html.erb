<script>
(function() {
  let page = 1;
  let loading = false;
  let hasMore = true;
  const container = document.getElementById('sharedFeedContent');
  const loadingEl = document.getElementById('sharedFeedLoading');

  function loadSharedItems() {
    if (loading || !hasMore) return;
    
    loading = true;
    loadingEl.style.display = 'block';
    
    fetch(`/shared/infinite?page=${page}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.shares && data.shares.length > 0) {
        data.shares.forEach(share => {
          const shareCard = createShareCard(share);
          container.appendChild(shareCard);
        });
        
        hasMore = data.has_more;
        page++;
      } else {
        hasMore = false;
        if (page === 1) {
          container.innerHTML = '<div class="shared-feed-empty"><p>No shared items yet.</p></div>';
        }
      }
      
      loading = false;
      loadingEl.style.display = 'none';
    })
    .catch(error => {
      console.error('Error loading shared items:', error);
      loading = false;
      loadingEl.style.display = 'none';
    });
  }

  function createShareCard(share) {
    const card = document.createElement('div');
    card.className = 'shared-feed-card';
    
    let contentHtml = '';
    
    if (share.type === 'claim') {
      contentHtml = `
        <div class="shared-feed-card-header">
          <div class="shared-by-info">
            <img src="${share.shared_by.avatar_url || '/assets/default-avatar.png'}" class="shared-by-avatar" />
            <div class="shared-by-details">
              <span class="shared-by-label">Shared by <strong>${share.shared_by.full_name || share.shared_by.email}</strong></span>
              <span class="shared-date">${formatDate(share.created_at)}</span>
            </div>
          </div>
        </div>
        <div class="shared-feed-card-content">
          <div class="shared-feed-badge fact">Fact</div>
          <div class="shared-feed-text">${escapeHtml(share.shareable.content)}</div>
          ${share.message ? `<div class="shared-message"><em>"${escapeHtml(share.message)}"</em></div>` : ''}
        </div>
        <div class="shared-feed-card-footer">
          <div class="shared-feed-actions">
            <span class="feed-like"><i class="fas fa-thumbs-up"></i> <span class="like-count">${share.shareable.likes_count}</span></span>
            <button class="shared-reshare-btn" data-share-id="${share.id}">
              <i class="fas fa-retweet"></i> Reshare
            </button>
          </div>
          <a href="/claims/${share.shareable.id}" class="shared-feed-link">View Details</a>
        </div>
      `;
    } else if (share.type === 'theory') {
      contentHtml = `
        <div class="shared-feed-card-header">
          <div class="shared-by-info">
            <img src="${share.shared_by.avatar_url || '/assets/default-avatar.png'}" class="shared-by-avatar" />
            <div class="shared-by-details">
              <span class="shared-by-label">Shared by <strong>${share.shared_by.full_name || share.shared_by.email}</strong></span>
              <span class="shared-date">${formatDate(share.created_at)}</span>
            </div>
          </div>
        </div>
        <div class="shared-feed-card-content">
          <div class="shared-feed-badge theory">Theory</div>
          <div class="shared-feed-title">${escapeHtml(share.shareable.title)}</div>
          <div class="shared-feed-text">${escapeHtml(share.shareable.description)}</div>
          ${share.message ? `<div class="shared-message"><em>"${escapeHtml(share.message)}"</em></div>` : ''}
        </div>
        <div class="shared-feed-card-footer">
          <div class="shared-feed-actions">
            <span class="feed-like"><i class="fas fa-thumbs-up"></i> <span class="like-count">${share.shareable.likes_count}</span></span>
            <button class="shared-reshare-btn" data-share-id="${share.id}">
              <i class="fas fa-retweet"></i> Reshare
            </button>
          </div>
        </div>
      `;
    } else if (share.type === 'comment') {
      contentHtml = `
        <div class="shared-feed-card-header">
          <div class="shared-by-info">
            <img src="${share.shared_by.avatar_url || '/assets/default-avatar.png'}" class="shared-by-avatar" />
            <div class="shared-by-details">
              <span class="shared-by-label">Shared by <strong>${share.shared_by.full_name || share.shared_by.email}</strong></span>
              <span class="shared-date">${formatDate(share.created_at)}</span>
            </div>
          </div>
        </div>
        <div class="shared-feed-card-content">
          <div class="shared-feed-badge comment">Comment</div>
          <div class="shared-feed-text">${escapeHtml(share.shareable.content)}</div>
          ${share.message ? `<div class="shared-message"><em>"${escapeHtml(share.message)}"</em></div>` : ''}
        </div>
      `;
    }
    
    card.innerHTML = contentHtml;
    return card;
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load initial items
  loadSharedItems();


  // Infinite scroll
  window.addEventListener('scroll', function() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
      loadSharedItems();
    }
  });
})();
</script>

