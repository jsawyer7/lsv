<script>
  // Use both DOMContentLoaded and window load to ensure everything is ready
  function initVeritalk() {
    const form = document.getElementById('veritalk-form');
    const input = document.getElementById('veritalk-input');
    const messagesDiv = document.getElementById('veritalk-messages');
    const conversationIdInput = document.getElementById('veritalk-conversation-id');

    if (!form || !input || !messagesDiv) {
      console.log('VeriTalk elements not found, retrying...');
      // Retry after a short delay if elements aren't ready
      setTimeout(initVeritalk, 200);
      return;
    }

    console.log('VeriTalk initialized');

    let isStreaming = false;
    
    // Initialize send button state
    const sendBtn = document.getElementById('veritalk-send-btn');
    if (sendBtn) {
      sendBtn.disabled = !input.value.trim();
    }

    // Load conversation history on page load
    async function loadConversationHistory() {
      console.log('Loading conversation history...');
      
      // Try to get conversation_id from localStorage first
      let conversationId = localStorage.getItem('veritalk_conversation_id');
      console.log('Conversation ID from localStorage:', conversationId);
      
      // If no conversation_id in localStorage, try to get from hidden input (for new conversations)
      if (!conversationId && conversationIdInput && conversationIdInput.value) {
        conversationId = conversationIdInput.value;
        console.log('Conversation ID from hidden input:', conversationId);
      }

      // If still no conversation_id, try to get the latest conversation
      if (!conversationId) {
        try {
          console.log('Fetching latest conversation...');
          const response = await fetch('/veritalk/latest');
          if (response.ok) {
            const data = await response.json();
            console.log('Latest conversation data:', data);
            if (data.conversation_id) {
              conversationId = data.conversation_id;
              console.log('Using latest conversation ID:', conversationId);
            }
          }
        } catch (error) {
          console.error('Error fetching latest conversation:', error);
        }
      }

      // Load messages if we have a conversation_id
      if (conversationId) {
        try {
          console.log('Loading messages for conversation:', conversationId);
          const response = await fetch(`/veritalk/conversation/${conversationId}/messages`);
          if (response.ok) {
            const data = await response.json();
            console.log('Loaded conversation data:', data);
            
            // Store conversation_id
            if (conversationIdInput) {
              conversationIdInput.value = data.conversation_id;
            }
            localStorage.setItem('veritalk_conversation_id', data.conversation_id);

            // Clear welcome message
            const welcome = messagesDiv.querySelector('.veritalk-welcome');
            if (welcome) {
              welcome.remove();
            }

            // Load messages
            if (data.messages && data.messages.length > 0) {
              console.log('Loading', data.messages.length, 'messages');
              // Clear any existing messages first (including welcome message)
              messagesDiv.innerHTML = '';
              
              data.messages.forEach((msg, index) => {
                appendMessage(msg.role, msg.content, false); // false = don't animate on load
              });
              
              // Scroll to bottom after a brief delay to ensure DOM is updated
              setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
              }, 50);
              
              console.log('Messages loaded successfully');
            } else {
              console.log('No messages found in conversation');
              // Keep welcome message if no messages
            }
          } else {
            console.log('Conversation not found, clearing localStorage');
            // Conversation not found, clear localStorage
            localStorage.removeItem('veritalk_conversation_id');
            if (conversationIdInput) {
              conversationIdInput.value = '';
            }
          }
        } catch (error) {
          console.error('Error loading conversation history:', error);
        }
      } else {
        console.log('No conversation ID found, showing welcome message');
      }
    }

    // Load history on page load - use a small delay to ensure DOM is ready
    setTimeout(() => {
      loadConversationHistory();
    }, 200);

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || isStreaming) return;

      appendMessage('user', text);
      input.value = '';

      startVeritalkStream(text);
    });

    // Auto-resize textarea
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
      
      // Enable/disable send button
      const sendBtn = document.getElementById('veritalk-send-btn');
      if (sendBtn) {
        sendBtn.disabled = !this.value.trim() || isStreaming;
      }
    });

    // Handle Enter key (Shift+Enter for new line)
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!isStreaming && this.value.trim()) {
          form.dispatchEvent(new Event('submit'));
        }
      }
    });

    function appendMessage(role, content, animate = true) {
      // Remove welcome message if it exists
      const welcome = messagesDiv.querySelector('.veritalk-welcome');
      if (welcome) {
        welcome.remove();
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = 'veritalk-message ' + role;
      if (!animate) {
        messageDiv.style.animation = 'none';
      }
      
      if (role === 'assistant') {
        const avatar = document.createElement('div');
        avatar.className = 'veritalk-message-avatar';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        messageDiv.appendChild(avatar);
      }
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'veritalk-message-content';
      contentDiv.textContent = content;
      messageDiv.appendChild(contentDiv);
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function startVeritalkStream(message) {
      isStreaming = true;
      
      // Disable input and send button
      input.disabled = true;
      const sendBtn = document.getElementById('veritalk-send-btn');
      if (sendBtn) {
        sendBtn.disabled = true;
      }

      // Remove welcome message if it exists
      const welcome = messagesDiv.querySelector('.veritalk-welcome');
      if (welcome) {
        welcome.remove();
      }

      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'veritalk-message assistant thinking';
      
      const avatar = document.createElement('div');
      avatar.className = 'veritalk-message-avatar';
      avatar.innerHTML = '<i class="fas fa-robot"></i>';
      thinkingDiv.appendChild(avatar);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'veritalk-message-content';
      contentDiv.textContent = 'VeriTalk is thinking...';
      thinkingDiv.appendChild(contentDiv);
      
      messagesDiv.appendChild(thinkingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const payload = {
        message: message
      };

      if (conversationIdInput && conversationIdInput.value) {
        payload.conversation_id = conversationIdInput.value;
      }

      try {
        const response = await fetch('/veritalk/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify(payload)
        });

        // Check if response is OK and is actually a stream
        if (!response.ok) {
          const errorText = await response.text();
          const contentDiv = thinkingDiv.querySelector('.veritalk-message-content');
          // Check if we got HTML (redirect page) instead of error message
          if (errorText.includes('<!DOCTYPE html>') || errorText.includes('<html>')) {
            if (contentDiv) {
              contentDiv.textContent = 'AI features require an active subscription. Please upgrade your plan to use VeriTalk.';
            } else {
              thinkingDiv.textContent = 'AI features require an active subscription. Please upgrade your plan to use VeriTalk.';
            }
          } else {
            if (contentDiv) {
              contentDiv.textContent = errorText || 'Sorry, VeriTalk had a problem.';
            } else {
              thinkingDiv.textContent = errorText || 'Sorry, VeriTalk had a problem.';
            }
          }
          isStreaming = false;
          input.disabled = false;
          const sendBtn = document.getElementById('veritalk-send-btn');
          if (sendBtn) {
            sendBtn.disabled = !input.value.trim();
          }
          return;
        }

        // Check content type to ensure it's a stream
        const contentType = response.headers.get('Content-Type');
        if (contentType && !contentType.includes('text/event-stream') && !contentType.includes('text/plain')) {
          const contentDiv = thinkingDiv.querySelector('.veritalk-message-content');
          if (contentDiv) {
            contentDiv.textContent = 'AI features require an active subscription. Please upgrade your plan to use VeriTalk.';
          } else {
            thinkingDiv.textContent = 'AI features require an active subscription. Please upgrade your plan to use VeriTalk.';
          }
          isStreaming = false;
          input.disabled = false;
          const sendBtn = document.getElementById('veritalk-send-btn');
          if (sendBtn) {
            sendBtn.disabled = !input.value.trim();
          }
          return;
        }

        const newConversationId = response.headers.get('X-Veritalk-Conversation-Id');
        if (newConversationId) {
          if (conversationIdInput) {
            conversationIdInput.value = newConversationId;
          }
          // Store in localStorage for persistence across page refreshes
          localStorage.setItem('veritalk_conversation_id', newConversationId);
          console.log('Saved conversation ID to localStorage:', newConversationId);
        }

        if (!response.body) {
          const contentDiv = thinkingDiv.querySelector('.veritalk-message-content');
          if (contentDiv) {
            contentDiv.textContent = 'Sorry, VeriTalk had a problem.';
          } else {
            thinkingDiv.textContent = 'Sorry, VeriTalk had a problem.';
          }
          isStreaming = false;
          input.disabled = false;
          const sendBtn = document.getElementById('veritalk-send-btn');
          if (sendBtn) {
            sendBtn.disabled = !input.value.trim();
          }
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        let assistantText = '';
        const contentDiv = thinkingDiv.querySelector('.veritalk-message-content');
        contentDiv.textContent = '';
        thinkingDiv.classList.remove('thinking');

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (!value) continue;

          const chunk = decoder.decode(value);
          assistantText += chunk;
          contentDiv.textContent = assistantText;
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        thinkingDiv.classList.add('assistant-final');
        isStreaming = false;
        
        // Re-enable input and send button
        input.disabled = false;
        input.focus();
        if (sendBtn) {
          sendBtn.disabled = !input.value.trim();
        }
      } catch (error) {
        console.error('VeriTalk error:', error);
        const contentDiv = thinkingDiv.querySelector('.veritalk-message-content');
        if (contentDiv) {
          contentDiv.textContent = 'Sorry, VeriTalk is unavailable right now.';
        } else {
          thinkingDiv.textContent = 'Sorry, VeriTalk is unavailable right now.';
        }
        isStreaming = false;
        
        // Re-enable input and send button
        input.disabled = false;
        if (sendBtn) {
          sendBtn.disabled = !input.value.trim();
        }
      }
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVeritalk);
  } else {
    // DOM is already ready
    initVeritalk();
  }

  // Also try on window load as a fallback
  window.addEventListener('load', function() {
    // Only load history if messages div is empty (hasn't been loaded yet)
    const messagesDiv = document.getElementById('veritalk-messages');
    if (messagesDiv && messagesDiv.querySelectorAll('.veritalk-message').length === 0) {
      const welcome = messagesDiv.querySelector('.veritalk-welcome');
      // If only welcome message exists, try loading history
      if (welcome && messagesDiv.children.length === 1) {
        console.log('Window loaded, checking for conversation history...');
        const conversationId = localStorage.getItem('veritalk_conversation_id');
        if (conversationId) {
          fetch(`/veritalk/conversation/${conversationId}/messages`)
            .then(response => response.json())
            .then(data => {
              if (data.messages && data.messages.length > 0) {
                welcome.remove();
                data.messages.forEach(msg => {
                  const messageDiv = document.createElement('div');
                  messageDiv.className = 'veritalk-message ' + msg.role;
                  messageDiv.style.animation = 'none';
                  
                  if (msg.role === 'assistant') {
                    const avatar = document.createElement('div');
                    avatar.className = 'veritalk-message-avatar';
                    avatar.innerHTML = '<i class="fas fa-robot"></i>';
                    messageDiv.appendChild(avatar);
                  }
                  
                  const contentDiv = document.createElement('div');
                  contentDiv.className = 'veritalk-message-content';
                  contentDiv.textContent = msg.content;
                  messageDiv.appendChild(contentDiv);
                  
                  messagesDiv.appendChild(messageDiv);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                const conversationIdInput = document.getElementById('veritalk-conversation-id');
                if (conversationIdInput) {
                  conversationIdInput.value = data.conversation_id;
                }
              }
            })
            .catch(error => console.error('Error loading history on window load:', error));
        }
      }
    }
  });

  // History Sidebar Functionality
  document.addEventListener('DOMContentLoaded', function() {
    const historyBtn = document.getElementById('veritalk-history-btn');
    const historySidebar = document.getElementById('veritalk-history-sidebar');
    const historyClose = document.getElementById('veritalk-history-close');
    const historyOverlay = document.getElementById('veritalk-history-overlay');
    const newChatBtn = document.getElementById('veritalk-new-chat-btn');
    const conversationsList = document.getElementById('veritalk-conversations-list');
    const conversationIdInput = document.getElementById('veritalk-conversation-id');
    const messagesDiv = document.getElementById('veritalk-messages');

    if (!historyBtn || !historySidebar || !historyClose || !historyOverlay) {
      return;
    }

    // Open sidebar
    function openHistorySidebar() {
      // Close user profile dropdown if open
      const dropdownMenu = document.querySelector('.dropdown-menu');
      const userInfo = document.querySelector('.user-info');
      if (dropdownMenu && dropdownMenu.classList.contains('show')) {
        dropdownMenu.classList.remove('show');
        if (userInfo) {
          userInfo.classList.remove('active');
        }
      }
      
      historySidebar.classList.add('active');
      historyOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      loadConversationsList();
    }

    // Close sidebar
    function closeHistorySidebar() {
      historySidebar.classList.remove('active');
      historyOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Load conversations list
    async function loadConversationsList() {
      if (!conversationsList) return;

      conversationsList.innerHTML = '<div class="veritalk-history-loading">Loading conversations...</div>';

      try {
        const response = await fetch('/veritalk/conversations');
        if (response.ok) {
          const data = await response.json();
          
          if (data.conversations && data.conversations.length > 0) {
            conversationsList.innerHTML = '';
            
            data.conversations.forEach(conv => {
              const item = document.createElement('div');
              item.className = 'veritalk-conversation-item';
              
              // Check if this is the active conversation
              const currentConvId = conversationIdInput ? conversationIdInput.value : localStorage.getItem('veritalk_conversation_id');
              if (currentConvId && currentConvId == conv.id) {
                item.classList.add('active');
              }
              
              item.innerHTML = `
                <div class="veritalk-conversation-topic">${escapeHtml(conv.topic)}</div>
                <div class="veritalk-conversation-meta">
                  <span class="veritalk-conversation-count">
                    <i class="fas fa-comments"></i>
                    ${conv.message_count} messages
                  </span>
                  <span>${formatDate(conv.updated_at)}</span>
                </div>
              `;
              
              item.addEventListener('click', function() {
                loadConversation(conv.id);
                closeHistorySidebar();
              });
              
              conversationsList.appendChild(item);
            });
          } else {
            conversationsList.innerHTML = `
              <div class="veritalk-empty-history">
                <h3>No chat history available</h3>
                <p>Your future conversations will appear here.</p>
              </div>
            `;
          }
        } else {
          conversationsList.innerHTML = '<div class="veritalk-history-loading">Error loading conversations</div>';
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
        conversationsList.innerHTML = '<div class="veritalk-history-loading">Error loading conversations</div>';
      }
    }

    // Load a specific conversation
    async function loadConversation(conversationId) {
      if (!messagesDiv) return;

      try {
        const response = await fetch(`/veritalk/conversation/${conversationId}/messages`);
        if (response.ok) {
          const data = await response.json();
          
          // Store conversation_id
          if (conversationIdInput) {
            conversationIdInput.value = data.conversation_id;
          }
          localStorage.setItem('veritalk_conversation_id', data.conversation_id);

          // Clear messages and load new ones
          messagesDiv.innerHTML = '';
          
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              const messageDiv = document.createElement('div');
              messageDiv.className = 'veritalk-message ' + msg.role;
              messageDiv.style.animation = 'none';
              
              if (msg.role === 'assistant') {
                const avatar = document.createElement('div');
                avatar.className = 'veritalk-message-avatar';
                avatar.innerHTML = '<i class="fas fa-robot"></i>';
                messageDiv.appendChild(avatar);
              }
              
              const contentDiv = document.createElement('div');
              contentDiv.className = 'veritalk-message-content';
              contentDiv.textContent = msg.content;
              messageDiv.appendChild(contentDiv);
              
              messagesDiv.appendChild(messageDiv);
            });
            
            setTimeout(() => {
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
          }
          
          // Reload conversations list to update active state
          loadConversationsList();
        }
      } catch (error) {
        console.error('Error loading conversation:', error);
      }
    }

    // Start new chat
    function startNewChat() {
      if (conversationIdInput) {
        conversationIdInput.value = '';
      }
      localStorage.removeItem('veritalk_conversation_id');
      
      // Clear messages and show welcome
      if (messagesDiv) {
        messagesDiv.innerHTML = `
          <div class="veritalk-welcome">
            <div class="veritalk-welcome-icon">
              <i class="fas fa-comments"></i>
            </div>
            <h3>How can I help you today?</h3>
            <p>I can help you with questions about religious texts, historical context, original languages, and translations.</p>
          </div>
        `;
      }
      
      closeHistorySidebar();
    }

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) {
        return 'Today';
      } else if (diffDays === 2) {
        return 'Yesterday';
      } else if (diffDays <= 7) {
        return `${diffDays - 1} days ago`;
      } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    }

    // Event listeners
    if (historyBtn) {
      historyBtn.addEventListener('click', openHistorySidebar);
    }

    if (historyClose) {
      historyClose.addEventListener('click', closeHistorySidebar);
    }

    if (historyOverlay) {
      historyOverlay.addEventListener('click', closeHistorySidebar);
    }

    if (newChatBtn) {
      newChatBtn.addEventListener('click', startNewChat);
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && historySidebar.classList.contains('active')) {
        closeHistorySidebar();
      }
    });
  });
</script>


