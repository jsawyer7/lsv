<%= javascript_tag do %>
  window.validatedClaim = null;

  function showClaimStep() {
    console.log('Showing claim step');
    document.getElementById('claim-step').style.display = 'block';
    document.getElementById('evidence-step').style.display = 'none';
  }

  function showClaimStepAndResetIllustration() {
    showClaimStep();
    const claimIllustration = document.getElementById('claim-illustration');
    const sourcesColumns = document.getElementById('sources-columns');
    if (claimIllustration) claimIllustration.style.display = 'block';
    if (sourcesColumns) sourcesColumns.style.display = 'none';
  }

  function showEvidenceStep() {
    console.log('Showing evidence step');
    document.getElementById('claim-step').style.display = 'none';
    document.getElementById('evidence-step').style.display = 'block';
    
    const validatedClaimDisplay = document.getElementById('validated-claim-display');
    if (validatedClaimDisplay && window.validatedClaim) {
      validatedClaimDisplay.value = window.validatedClaim;
    }
    
    // Reset the state of the evidence form to allow re-validation.
    const evidenceInput = document.querySelector('textarea[name="claim[evidence]"]');
    const validateEvidenceBtn = document.getElementById('validate-evidence');
    const submitBtn = document.getElementById('submit-claim');
    const editEvidenceBtn = document.getElementById('edit-evidence-btn');
    const claimIllustration = document.getElementById('claim-illustration');
    const sourcesColumns = document.getElementById('sources-columns');
    const evidenceError = document.querySelector('.evidence-error');
    const addEvidenceBtn = document.getElementById('add-evidence-btn');
    const evidencesContainer = document.getElementById('evidences-container');

    // If sources columns are visible, evidence is validated
    if (sourcesColumns && sourcesColumns.style.display === 'flex') {
      // Evidence validated: show edit evidence button, disable add evidence
      if (editEvidenceBtn) editEvidenceBtn.style.display = 'inline-block';
      if (addEvidenceBtn) {
        addEvidenceBtn.disabled = true;
        addEvidenceBtn.style.display = 'none';
      }
      // Make all evidence textareas readOnly
      if (evidencesContainer) {
        const evidenceTextareas = evidencesContainer.querySelectorAll('.evidence-textarea');
        evidenceTextareas.forEach(textarea => {
          textarea.readOnly = true;
          textarea.style.background = '#f3f4f6';
          textarea.style.color = '#23263b';
        });
        // Disable all remove evidence buttons
        const removeBtns = evidencesContainer.querySelectorAll('.remove-evidence-btn');
        removeBtns.forEach(btn => btn.disabled = true);
      }
    } else {
      // Not validated: hide edit evidence button, enable add evidence, make evidence editable
      if (editEvidenceBtn) editEvidenceBtn.style.display = 'none';
      if (addEvidenceBtn) {
        addEvidenceBtn.disabled = false;
        addEvidenceBtn.style.display = 'inline-block';
      }
      // Make all evidence textareas editable
      if (evidencesContainer) {
        const evidenceTextareas = evidencesContainer.querySelectorAll('.evidence-textarea');
        evidenceTextareas.forEach(textarea => {
          textarea.readOnly = false;
          textarea.style.background = 'white';
          textarea.style.color = 'inherit';
        });
        // Enable all remove evidence buttons (except if only one evidence box)
        const removeBtns = evidencesContainer.querySelectorAll('.remove-evidence-btn');
        const boxes = evidencesContainer.querySelectorAll('.evidence-box');
        removeBtns.forEach(btn => btn.disabled = boxes.length === 1);
      }
    }

    if (validateEvidenceBtn) validateEvidenceBtn.style.display = 'inline-block';
    if (submitBtn) submitBtn.style.display = 'none';
    if (claimIllustration) claimIllustration.style.display = 'block';
    if (sourcesColumns) sourcesColumns.style.display = 'none';
    if (evidenceError) {
      evidenceError.style.display = 'none';
      evidenceError.textContent = '';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up form handlers');
    
    const form = document.getElementById('claim-form');
    const validateButton = document.getElementById('validate-claim');
    const submitButton = document.getElementById('submit-claim');
    const claimInput = form.querySelector('[name="claim[content]"]');
    const evidenceInput = form.querySelector('[name="claim[evidence]"]');
    const errorMessage = document.querySelector('.error-message');
    const evidenceError = document.querySelector('.evidence-error');
    const submitLoader = document.getElementById('submit-loader-overlay');

    // Validate claim button handler
    validateButton.addEventListener('click', function() {
      console.log('Validate button clicked');
      const content = claimInput.value;
      
      if (!content.trim()) {
        errorMessage.textContent = 'Please enter a claim';
        errorMessage.style.display = 'block';
        return;
      }

      validateButton.disabled = true;
      validateButton.textContent = 'Validating...';

      console.log('Sending validation request for:', content);
      fetch('/claims/validate_claim', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector("[name='csrf-token']").content
        },
        body: JSON.stringify({ claim: { content: content } })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Validation response:', data);
        if (data.valid) {
          window.validatedClaim = data.cleaned_claim;
          claimInput.value = data.cleaned_claim;
          errorMessage.style.display = 'none';
          // Hide chatbot, show illustration if previously hidden
          document.getElementById('ai-chatbot-container').style.display = 'none';
          document.getElementById('claim-illustration').style.display = 'block';
          showEvidenceStep();
        } else {
          // Hide illustration, show chatbot
          document.getElementById('claim-illustration').style.display = 'none';
          document.getElementById('ai-chatbot-container').style.display = 'flex';
          // Start chatbot with failed claim and error message
          startAIChatbot(content, data.error);
        }
      })
      .catch(error => {
        console.error('Validation error:', error);
        errorMessage.textContent = 'An error occurred while validating the claim';
        errorMessage.style.display = 'block';
      })
      .finally(() => {
        validateButton.disabled = false;
        validateButton.textContent = 'Continue';
      });
    });

    // Form submission handler
    form.addEventListener('submit', function(e) {
      console.log('Form submit triggered');
      e.preventDefault();
      
      // Combine all evidence textarea values into one string
      const evidencesContainer = document.getElementById('evidences-container');
      const evidenceTextareas = evidencesContainer ? evidencesContainer.querySelectorAll('.evidence-textarea') : [];
      const combinedEvidence = Array.from(evidenceTextareas).map(t => t.value.trim()).filter(Boolean).join('\n');
      const combinedEvidenceField = document.getElementById('combined-evidence-field');
      if (combinedEvidenceField) combinedEvidenceField.value = combinedEvidence;

      const evidence = combinedEvidence;
      console.log('Current values:', {
        claim: claimInput.value,
        validatedClaim: window.validatedClaim,
        evidence: evidence
      });

      if (!evidence.trim()) {
        console.log('Evidence missing');
        evidenceError.textContent = 'Please enter evidence';
        evidenceError.style.display = 'block';
        return;
      }

      if (!window.validatedClaim) {
        console.log('No validated claim found');
        errorMessage.textContent = 'Please validate your claim first';
        showClaimStep();
        return;
      }

      // Set the final values
      claimInput.value = window.validatedClaim;
      
      console.log('Submitting form with:', {
        finalClaim: claimInput.value,
        finalEvidence: evidence
      });

      // Show loader before submitting
      if(submitLoader) {
        const saveAsDraftField = document.getElementById('save-as-draft-field');
        const loaderText = submitLoader.querySelector('.loader-text');

        if (loaderText && saveAsDraftField && saveAsDraftField.value === 'true') {
          loaderText.textContent = 'Saving claim...';
        } else if (loaderText) {
          loaderText.textContent = 'Submitting claim...';
        }
        
        submitLoader.classList.add('active');
      }

      // Disable the submit button
      submitButton.disabled = true;
      
      // Submit the form
      form.submit();
    });

    // --- AI Chatbot logic ---
    function appendChatMessage(role, text) {
      const messagesDiv = document.getElementById('ai-chatbot-messages');
      const msg = document.createElement('div');
      msg.className = 'ai-chatbot-message ' + (role === 'user' ? 'user' : 'ai');
      msg.textContent = text;
      messagesDiv.appendChild(msg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function startAIChatbot(failedClaim, errorMsg) {
      const messagesDiv = document.getElementById('ai-chatbot-messages');
      messagesDiv.innerHTML = '';
      appendChatMessage('user', failedClaim);
      // Start streaming AI response
      streamAIResponse(failedClaim, errorMsg);
    }

    function streamAIResponse(failedClaim, errorMsg) {
      // Show AI is typing...
      appendChatMessage('ai', 'Thinking...');
      // Replace with your backend endpoint for streaming AI (e.g. /ai/claim_suggestion)
      const messagesDiv = document.getElementById('ai-chatbot-messages');
      fetch('/ai/claim_suggestion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector("[name='csrf-token']").content
        },
        body: JSON.stringify({ claim: failedClaim, error: errorMsg })
      })
      .then(async response => {
        if (!response.body) throw new Error('No response body');
        // Remove 'Thinking...' message
        messagesDiv.removeChild(messagesDiv.lastChild);
        const reader = response.body.getReader();
        let aiMsg = '';
        let done = false;
        const aiDiv = document.createElement('div');
        aiDiv.className = 'ai-chatbot-message ai';
        messagesDiv.appendChild(aiDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        let buffer = '';
        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          if (value) {
            const chunk = new TextDecoder().decode(value);
            buffer += chunk;
            // Show letter by letter
            while (buffer.length > 0) {
              aiMsg += buffer[0];
              aiDiv.textContent = aiMsg;
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
              buffer = buffer.slice(1);
              await new Promise(r => setTimeout(r, 12)); // Typing speed (ms per char)
            }
          }
        }
      })
      .catch(err => {
        appendChatMessage('ai', 'Sorry, there was a problem getting suggestions.');
      });
    }

    // Chatbot input handler
    document.getElementById('ai-chatbot-send').addEventListener('click', function() {
      const input = document.getElementById('ai-chatbot-input');
      const text = input.value.trim();
      if (!text) return;
      appendChatMessage('user', text);
      input.value = '';
      // Stream AI response to user message
      streamAIResponse(text, '');
    });
    document.getElementById('ai-chatbot-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('ai-chatbot-send').click();
      }
    });
  });

  function openDeleteClaimModal(claimId) {
    var modal = document.getElementById('delete-claim-modal');
    var form = document.getElementById('delete-claim-form');
    form.action = '/claims/' + claimId;
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
  }
  function closeDeleteClaimModal() {
    var modal = document.getElementById('delete-claim-modal');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
  }
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.my-claim-delete-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        openDeleteClaimModal(this.getAttribute('data-claim-id'));
      });
    });
  });
<% end %>