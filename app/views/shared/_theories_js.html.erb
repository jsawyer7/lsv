<script>
document.addEventListener('DOMContentLoaded', function() {
  // Make the page static
  document.body.style.overflow = 'hidden';
  document.querySelector('.dashboard-main').style.overflow = 'hidden';

  const theoryList = document.getElementById('theory-list');
  const theoryLoader = document.getElementById('theory-loader');
  const filters = document.querySelectorAll('.theories-filter');
  const searchInput = document.querySelector('.theories-search-bar input');
  let page = 1;
  let loading = false;
  let hasMore = true;
  let currentStatus = '<%= @current_status %>';
  let currentSearch = '<%= params[:search].to_s %>';

  // Set fixed height for theory list container
  theoryList.style.height = 'calc(100vh - 200px)';
  theoryList.style.overflowY = 'auto';

  function renderTheory(theory) {
    // Determine like button HTML
    let likeButtonHtml;
    const likesCount = theory.likes_count || 0;
    
    if (theory.user_liked && theory.like_id) {
      // User has liked - show unlike button
      likeButtonHtml = `<a href="/theories/${theory.id}/likes/${theory.like_id}" class="feed-like liked" data-method="delete" data-remote="true" data-theory-id="${theory.id}">
        <i class="fas fa-thumbs-up"></i> <span class="like-count">${likesCount}</span>
      </a>`;
    } else {
      // User hasn't liked - show like button
      likeButtonHtml = `<a href="/theories/${theory.id}/likes" class="feed-like" data-method="post" data-remote="true" data-theory-id="${theory.id}">
        <i class="fas fa-thumbs-up"></i> <span class="like-count">${likesCount}</span>
      </a>`;
    }
    
    return `
      <div class="feed-card">
        <div class="feed-card-header">
          <div class="feed-card-badge-user">
            <span class="feed-card-badge theory">Theory</span>
            <span class="feed-card-user">Anonymous</span>
          </div>
        </div>
        <div class="feed-card-title">${theory.title}</div>
        <div class="feed-card-content">${theory.description || ''}</div>
        <div class="feed-card-footer">
          <div class="feed-card-actions">
            ${likeButtonHtml}
          </div>
          <span class="feed-card-date">${new Date(theory.created_at).toLocaleDateString()}</span>
          <a class="feed-card-link" href="#">View Details</a>
        </div>
      </div>
    `;
  }

  async function fetchTheories(reset = false) {
    if (loading || !hasMore) return;
    loading = true;
    theoryLoader.style.display = 'block';
    if (reset) {
      theoryList.innerHTML = '';
      page = 0;
      hasMore = true;
    }
    if (page === 0) {
      page = 1;
      loading = false;
      theoryLoader.style.display = 'none';
      return;
    }
    const res = await fetch(`/theories/infinite?page=${page}&status=${currentStatus}&search=${encodeURIComponent(currentSearch)}`);
    const data = await res.json();
    data.theories.forEach(theory => {
      theoryList.insertAdjacentHTML('beforeend', renderTheory(theory));
    });
    hasMore = data.has_more;
    loading = false;
    theoryLoader.style.display = hasMore ? 'block' : 'none';
    page++;
  }

  function onTheoryScroll() {
    if (theoryList.scrollTop + theoryList.clientHeight >= theoryList.scrollHeight - 200) {
      fetchTheories();
    }
  }

  theoryList.addEventListener('scroll', onTheoryScroll);
  
  // Handle like button clicks for dynamically added elements
  theoryList.addEventListener('click', function(e) {
    const likeButton = e.target.closest('.feed-like');
    if (!likeButton || likeButton.tagName !== 'A') return;
    
    e.preventDefault();
    const theoryId = likeButton.getAttribute('data-theory-id');
    const isLiked = likeButton.classList.contains('liked');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    let url, method;
    if (isLiked) {
      // Unlike - extract like ID from href
      url = likeButton.href;
      method = 'DELETE';
    } else {
      // Like
      url = `/theories/${theoryId}/likes`;
      method = 'POST';
    }
    
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
        'Accept': 'application/json'
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        const likeCountSpan = likeButton.querySelector('.like-count');
        if (likeCountSpan) {
          likeCountSpan.textContent = data.likes_count;
        }
        
        if (isLiked) {
          // User unliked - change to like button
          likeButton.classList.remove('liked');
          likeButton.href = `/theories/${theoryId}/likes`;
          likeButton.setAttribute('data-method', 'post');
          likeButton.setAttribute('data-remote', 'true');
        } else {
          // User liked - change to unlike button
          likeButton.classList.add('liked');
          if (data.like_id) {
            likeButton.href = `/theories/${theoryId}/likes/${data.like_id}`;
            likeButton.setAttribute('data-method', 'delete');
            likeButton.setAttribute('data-remote', 'true');
          }
        }
      }
    })
    .catch(error => {
      console.error('Error liking/unliking theory:', error);
    });
  });

  if (searchInput) {
    searchInput.addEventListener('input', function() {
      currentSearch = this.value;
      theoryList.innerHTML = '';
      page = 0;
      hasMore = true;
      fetchTheories(true);
    });
  }

  // Delete modal logic for theories
  function openDeleteTheoryModal(theoryId) {
    var modal = document.getElementById('delete-theory-modal');
    var form = document.getElementById('delete-theory-form');
    form.action = '/theories/' + theoryId;
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
  }
  function closeDeleteTheoryModal() {
    var modal = document.getElementById('delete-theory-modal');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
  }
  document.querySelectorAll('.my-claim-delete-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      openDeleteTheoryModal(this.getAttribute('data-theory-id'));
    });
  });

  // Add event listener for the delete modal close button
  var closeBtn = document.querySelector('.delete-claim-modal-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      closeDeleteTheoryModal();
    });
  }
});
</script> 